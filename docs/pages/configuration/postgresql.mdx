# PostgreSQL Configuration

Configure the PostgreSQL connection for the Orleans.Search index.

## Basic Configuration

```csharp
builder.Services.AddOrleansSearch()
    .UsePostgreSql("Host=localhost;Database=orleanssearch;Username=postgres;Password=postgres");
```

## Connection String Format

Use standard Npgsql connection string format:

```
Host=hostname;Database=dbname;Username=user;Password=password
```

Common parameters:

| Parameter | Description | Example |
|-----------|-------------|---------|
| `Host` | Server hostname or IP | `localhost`, `db.example.com` |
| `Port` | Server port | `5432` (default) |
| `Database` | Database name | `orleanssearch` |
| `Username` | PostgreSQL user | `postgres` |
| `Password` | User password | `mypassword` |
| `SSL Mode` | SSL connection mode | `Require`, `Prefer` |

## Connection String Examples

### Local Development

```csharp
.UsePostgreSql("Host=localhost;Database=orleanssearch;Username=postgres;Password=postgres")
```

### Docker Container

```csharp
.UsePostgreSql("Host=postgres;Port=5432;Database=orleanssearch;Username=postgres;Password=postgres")
```

### Azure Database for PostgreSQL

```csharp
.UsePostgreSql("Host=myserver.postgres.database.azure.com;Database=orleanssearch;Username=admin@myserver;Password=mypassword;SSL Mode=Require")
```

### AWS RDS PostgreSQL

```csharp
.UsePostgreSql("Host=myinstance.xxxx.us-east-1.rds.amazonaws.com;Database=orleanssearch;Username=postgres;Password=mypassword;SSL Mode=Require")
```

## Using Configuration

Load the connection string from configuration:

```csharp
// appsettings.json
{
  "ConnectionStrings": {
    "SearchIndex": "Host=localhost;Database=orleanssearch;Username=postgres;Password=postgres"
  }
}

// Program.cs
builder.Services.AddOrleansSearch()
    .UsePostgreSql(builder.Configuration.GetConnectionString("SearchIndex")!);
```

## Using Environment Variables

```csharp
var connectionString = Environment.GetEnvironmentVariable("SEARCH_INDEX_CONNECTION")
    ?? "Host=localhost;Database=orleanssearch;Username=postgres;Password=postgres";

builder.Services.AddOrleansSearch()
    .UsePostgreSql(connectionString);
```

## Database Setup

Orleans.Search uses EF Core, which can automatically create the database schema.

### Automatic Migration

The database schema is created automatically on first use. No manual migration is required.

### Manual Schema Creation

If you prefer to create the schema manually:

```sql
-- Create the database
CREATE DATABASE orleanssearch;

-- The tables are created automatically by EF Core
-- on first application startup
```

## Connection Pooling

Npgsql manages connection pooling automatically. You can tune it with connection string parameters:

```
Host=localhost;Database=orleanssearch;Username=postgres;Password=postgres;Minimum Pool Size=10;Maximum Pool Size=100
```

| Parameter | Default | Description |
|-----------|---------|-------------|
| `Minimum Pool Size` | 0 | Minimum connections to keep open |
| `Maximum Pool Size` | 100 | Maximum concurrent connections |
| `Connection Idle Lifetime` | 300 | Seconds before idle connection is closed |
| `Connection Pruning Interval` | 10 | Seconds between pruning checks |

## Troubleshooting

### Connection Refused

```
Npgsql.NpgsqlException: Failed to connect to localhost:5432
```

- Verify PostgreSQL is running
- Check the host and port
- Ensure firewall allows connections

### Authentication Failed

```
Npgsql.PostgresException: password authentication failed for user "postgres"
```

- Verify username and password
- Check `pg_hba.conf` authentication settings

### Database Does Not Exist

```
Npgsql.PostgresException: database "orleanssearch" does not exist
```

- Create the database: `CREATE DATABASE orleanssearch;`
- Or let EF Core create it on first use

### SSL Required

```
Npgsql.PostgresException: SSL connection is required
```

Add `SSL Mode=Require` to your connection string:

```
Host=myserver.example.com;Database=orleanssearch;Username=user;Password=pass;SSL Mode=Require
```

## Performance Recommendations

1. **Use connection pooling** - Npgsql pools connections by default
2. **Size the pool appropriately** - Match pool size to expected concurrency
3. **Use indexes** - Mark frequently-filtered properties with `[Queryable(Indexed = true)]`
4. **Monitor query performance** - Use PostgreSQL's `pg_stat_statements`

## Next Steps

- [Query API](/query-api/search-client) - Learn how to query grains
- [Examples](/examples/user-management) - See complete examples
